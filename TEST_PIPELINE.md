# AI Pipeline Test Guide

## üöÄ Quick Test

### 1. Start Server
```powershell
python main.py
```

### 2. Test Upload (V2 Endpoint)
```bash
curl -X POST http://127.0.0.1:8082/api/v1/upap/upload \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@test_image.jpg" \
  -F "email=user@example.com"
```

**Expected Response:**
```json
{
  "status": "ok",
  "preview_id": "uuid-here",
  "message": "File uploaded. AI pipeline started automatically."
}
```

### 3. Check AI Pipeline Status
```bash
# Check logs
tail -f logs/pipeline.log

# Or check database
# Preview record should have state = AI_ANALYZED
```

### 4. Test Archive (V2 Endpoint)
```bash
curl -X POST http://127.0.0.1:8082/api/v1/upap/archive \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"preview_id": "uuid-from-upload"}'
```

**Expected Response:**
```json
{
  "status": "ok",
  "record_id": "uuid-here",
  "message": "Record archived successfully"
}
```

## üìä Verify Pipeline Execution

### Check Logs
```bash
# View pipeline logs
cat logs/pipeline.log | jq '.'

# Filter by preview_id
cat logs/pipeline.log | jq 'select(.preview_id == "your-preview-id")'
```

### Check Database
```sql
-- Preview records
SELECT preview_id, state, confidence, model_used, cost_estimate 
FROM preview_records 
ORDER BY created_at DESC 
LIMIT 10;

-- Archive records
SELECT record_id, preview_id, state, confidence, enrichment_source 
FROM archive_records_v2 
ORDER BY archived_at DESC 
LIMIT 10;
```

## ‚úÖ Success Criteria

1. ‚úÖ Upload returns only `preview_id`
2. ‚úÖ AI pipeline runs automatically (async)
3. ‚úÖ Logs show each step executed
4. ‚úÖ Database shows state transitions
5. ‚úÖ Archive accepts only `preview_id`
6. ‚úÖ Archive returns `record_id` (generated by backend)

## üîç Troubleshooting

### Database Tables Not Created
```python
# Run in Python console
from backend.db import init_db
init_db()
```

### AI Pipeline Not Running
- Check logs: `logs/pipeline.log`
- Check database: `preview_records.state` should change to `AI_ANALYZED`
- Check server logs for errors

### Import Errors
- Ensure all dependencies installed: `pip install -r requirements.txt`
- Check Python path: `python -c "import backend.services.ai_pipeline"`
