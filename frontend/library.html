<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library – Novitsky Archive</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #F9FAFB;
      color: #111827;
      min-height: 100vh;
    }

    /* Navbar */
    header {
      background: #FFFFFF;
      border-bottom: 1px solid #E5E7EB;
      padding: 16px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      position: relative;
    }

    .header-title {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
      letter-spacing: -0.5px;
    }

    .mobile-menu-toggle {
      display: none;
      background: none;
      border: none;
      color: #111827;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
    }

    .header-nav {
      display: flex;
      gap: 32px;
      align-items: center;
    }

    .header-nav a {
      color: #6B7280;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: color 0.2s;
    }

    .header-nav a:hover {
      color: #111827;
    }

    .header-nav a.active {
      color: #4F46E5;
    }

    /* Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 48px 24px;
    }

    /* Page Header */
    .page-header {
      margin-bottom: 32px;
    }

    .page-header h1 {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 8px;
    }

    .page-header p {
      color: #6B7280;
      font-size: 14px;
    }

    /* Search Bar */
    .search-container {
      background: #FFFFFF;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
      border: 1px solid #E5E7EB;
    }

    .search-bar {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .search-bar:focus {
      outline: none;
      border-color: #4F46E5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    /* Records Grid */
    .records-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 24px;
    }

    .record-card {
      background: #FFFFFF;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
      border: 1px solid #E5E7EB;
      transition: all 0.2s;
      cursor: pointer;
    }

    .record-card:hover {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .record-image {
      width: 100%;
      height: 240px;
      object-fit: cover;
      background: #F3F4F6;
    }

    .record-content {
      padding: 20px;
    }

    .record-title {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }

    .record-artist {
      font-size: 14px;
      color: #6B7280;
      margin-bottom: 16px;
    }

    .record-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #E5E7EB;
    }

    .meta-item {
      font-size: 12px;
      color: #6B7280;
    }

    .meta-item strong {
      color: #111827;
      font-weight: 600;
    }

    /* Pricing Section */
    .pricing-section {
      margin-top: 16px;
      padding: 16px;
      background: #F9FAFB;
      border-radius: 8px;
      border: 1px solid #E5E7EB;
    }

    .pricing-header {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }

    .price-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .price-label {
      color: #6B7280;
    }

    .price-value {
      font-weight: 600;
      color: #111827;
    }

    .price-low {
      color: #059669;
    }

    .price-high {
      color: #DC2626;
    }

    .estimated-value {
      font-size: 16px;
      font-weight: 700;
      color: #4F46E5;
      padding-top: 12px;
      border-top: 2px solid #E5E7EB;
      margin-top: 8px;
    }

    .condition-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      background: #EEF2FF;
      color: #4F46E5;
    }

    .loading-price {
      color: #9CA3AF;
      font-size: 12px;
      font-style: italic;
    }

    .fetch-price-btn {
      margin-top: 8px;
      padding: 6px 12px;
      font-size: 12px;
      background: #4F46E5;
      color: #FFFFFF;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
    }

    .fetch-price-btn:hover {
      background: #4338CA;
    }

    .fetch-price-btn:disabled {
      background: #D1D5DB;
      cursor: not-allowed;
    }

    .record-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #E5E7EB;
    }

    .btn {
      flex: 1;
      padding: 8px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 6px;
      background: #FFFFFF;
      color: #374151;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      background: #F9FAFB;
      border-color: #9CA3AF;
    }

    .btn-primary {
      background: #4F46E5;
      color: #FFFFFF;
      border-color: #4F46E5;
    }

    .btn-primary:hover {
      background: #4338CA;
      border-color: #4338CA;
    }

    .btn-danger {
      background: #EF4444;
      color: #FFFFFF;
      border-color: #EF4444;
    }

    .btn-danger:hover {
      background: #DC2626;
      border-color: #DC2626;
    }

    /* Empty State */
    .empty-state {
      background: #FFFFFF;
      border-radius: 12px;
      padding: 64px 24px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #E5E7EB;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .empty-state h2 {
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }

    .empty-state p {
      color: #6B7280;
      font-size: 14px;
      margin-bottom: 24px;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 64px 24px;
      color: #6B7280;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #E5E7EB;
      border-top-color: #4F46E5;
      border-radius: 50%;
      margin: 0 auto 16px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Edit Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #FFFFFF;
      border-radius: 12px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      margin-bottom: 24px;
    }

    .modal-header h2 {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #D1D5DB;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #4F46E5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .modal-actions .btn {
      flex: 1;
    }

    /* Footer */
    footer {
      background: #FFFFFF;
      border-top: 1px solid #E5E7EB;
      padding: 32px 40px;
      margin-top: 64px;
      text-align: center;
      color: #6B7280;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      header {
        padding: 16px 20px;
        flex-wrap: wrap;
      }

      .mobile-menu-toggle {
        display: block;
      }

      .header-nav {
        display: none;
        flex-direction: column;
        width: 100%;
        gap: 8px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #E5E7EB;
      }

      .header-nav.active {
        display: flex;
      }

      .header-nav a {
        width: 100%;
        text-align: center;
        padding: 12px 16px;
      }

      .container {
        padding: 24px 16px;
      }

      .page-header h1 {
        font-size: 24px;
      }

      .records-grid {
        grid-template-columns: 1fr;
      }

      .record-card {
        margin-bottom: 16px;
      }

      .modal-content {
        padding: 24px 20px;
        width: 95%;
      }

      footer {
        padding: 24px 20px;
      }
    }

    @media (max-width: 480px) {
      .page-header h1 {
        font-size: 20px;
      }

      .search-container {
        padding: 16px;
      }

      .record-content {
        padding: 16px;
      }
    }
  </style>
</head>
<body>

<header>
    <div class="header-title">Novitsky AI</div>
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
    <nav class="header-nav" id="mobileNav">
        <a href="index.html">Home</a>
        <a href="upload.html">Upload</a>
        <a href="library.html" class="active">Library</a>
        <a href="login.html">Account</a>
    </nav>
</header>

<div class="container">
    <div class="page-header">
        <h1>My Archive</h1>
        <p>View and manage your archived records</p>
    </div>

    <div class="search-container">
        <input 
            type="text" 
            id="searchInput" 
            class="search-bar" 
            placeholder="Search by artist, album, or label..."
            oninput="filterRecords()"
        >
    </div>

    <div id="recordsContainer">
        <div class="loading">
            <div class="loading-spinner"></div>
            <div>Loading archive...</div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Record</h2>
        </div>
        <form id="editForm">
            <input type="hidden" id="editArchiveId">
            
            <div class="form-group">
                <label class="form-label">Artist</label>
                <input type="text" id="editArtist" class="form-input">
            </div>
            
            <div class="form-group">
                <label class="form-label">Album</label>
                <input type="text" id="editAlbum" class="form-input">
            </div>
            
            <div class="form-group">
                <label class="form-label">Label</label>
                <input type="text" id="editLabel" class="form-input">
            </div>
            
            <div class="form-group">
                <label class="form-label">Year</label>
                <input type="text" id="editYear" class="form-input">
            </div>
            
            <div class="form-group">
                <label class="form-label">Catalog Number</label>
                <input type="text" id="editCatalog" class="form-input">
            </div>
            
            <div class="form-group">
                <label class="form-label">Condition</label>
                <select id="editCondition" class="form-input">
                    <option value="">Select condition</option>
                    <option value="M">Mint (M) - 100%</option>
                    <option value="NM">Near Mint (NM) - 95%</option>
                    <option value="VG+">Very Good Plus (VG+) - 85%</option>
                    <option value="VG">Very Good (VG) - 70%</option>
                    <option value="G+">Good Plus (G+) - 50%</option>
                    <option value="G">Good (G) - 30%</option>
                    <option value="P">Poor (P) - 10%</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">User Estimate (USD)</label>
                <input type="number" id="editUserEstimate" class="form-input" step="0.01" min="0" placeholder="Optional">
                <small style="color: #6B7280; font-size: 12px; display: block; margin-top: 4px;">Leave empty to use market price</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Market Prices</label>
                <button type="button" class="fetch-price-btn" onclick="fetchMarketPrices()">
                    Fetch Market Prices from Discogs
                </button>
                <div id="priceInfo" style="margin-top: 12px; font-size: 12px; color: #6B7280;"></div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<footer>
    <p><strong>Records_AI (UPAP Tabanlı Arşivleme Platformu)</strong></p>
    <p>Developed and owned by Merve Emecan Sanli</p>
</footer>

<script>
// Mobile menu toggle
function toggleMobileMenu() {
    const nav = document.getElementById('mobileNav');
    nav.classList.toggle('active');
}

// Close mobile menu when clicking outside
document.addEventListener('click', function(event) {
    const nav = document.getElementById('mobileNav');
    const toggle = document.querySelector('.mobile-menu-toggle');
    if (nav && toggle && !nav.contains(event.target) && !toggle.contains(event.target)) {
        nav.classList.remove('active');
    }
});

const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
    ? 'http://127.0.0.1:8000'
    : 'https://api.zyagrolia.com';

let allRecords = [];
let currentUser = null;

// Check authentication
window.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('auth_token');
    const email = localStorage.getItem('user_email');
    
    if (!token || !email) {
        window.location.href = 'login.html?return=' + encodeURIComponent('library.html');
        return;
    }
    
    currentUser = { email, token };
    loadLibrary();
});

async function loadLibrary() {
    try {
        const response = await fetch(`${API_BASE}/upap/archive/list`, {
            headers: {
                'Authorization': `Bearer ${currentUser.token}`
            }
        });

        if (!response.ok) {
            throw new Error(`Failed to load library: ${response.status}`);
        }

        const data = await response.json();
        allRecords = data.records || [];
        
        // Load listings for each record
        for (let record of allRecords) {
            try {
                const listingsResponse = await fetch(`${API_BASE}/marketplace/listings/${record.archive_id}`, {
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`
                    }
                });
                
                if (listingsResponse.ok) {
                    const listingsData = await listingsResponse.json();
                    record.listings = listingsData.listings || [];
                }
            } catch (e) {
                record.listings = [];
            }
        }
        
        renderRecords(allRecords);
    } catch (error) {
        console.error('Error loading library:', error);
        document.getElementById('recordsContainer').innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">⚠️</div>
                <h2>Error Loading Archive</h2>
                <p>${error.message}</p>
            </div>
        `;
    }
}

function renderPricingSection(record) {
    // Get pricing data from multiple possible locations
    const pricingData = record.pricing_data || {};
    const marketPrices = pricingData.market_prices || record.market_prices || {};
    
    // Direct price fields (from automatic pricing on archive)
    const priceLow = record.price_low || marketPrices.price_low || pricingData.price_low;
    const priceHigh = record.price_high || marketPrices.price_high || pricingData.price_high;
    const priceMedian = record.price_median || marketPrices.price_median || pricingData.price_median;
    
    const estimatedValue = record.estimated_value || record.condition_adjusted || null;
    const condition = record.media_condition || record.condition || '';
    const userEstimate = record.user_estimated_value || null;
    
    // Show pricing section if we have any price data
    if (!priceLow && !priceHigh && !estimatedValue && !condition) {
        return '';
    }
    
    let priceHtml = '<div class="pricing-section">';
    priceHtml += '<div class="pricing-header">💰 Market Value</div>';
    
    // Show market range (EN DÜŞÜK - EN YÜKSEK)
    if (priceLow || priceHigh) {
        priceHtml += `<div class="price-row"><span class="price-label">Market Range:</span>`;
        if (priceLow && priceHigh) {
            priceHtml += `<span class="price-value"><span class="price-low">$${priceLow.toFixed(2)}</span> - <span class="price-high">$${priceHigh.toFixed(2)}</span></span>`;
        } else if (priceLow) {
            priceHtml += `<span class="price-value price-low">From $${priceLow.toFixed(2)}</span>`;
        } else if (priceHigh) {
            priceHtml += `<span class="price-value price-high">Up to $${priceHigh.toFixed(2)}</span>`;
        }
        priceHtml += '</div>';
        
        // Show median if available
        if (priceMedian) {
            priceHtml += `<div class="price-row"><span class="price-label">Median:</span><span class="price-value">$${priceMedian.toFixed(2)}</span></div>`;
        }
    }
    
    // Show condition if available
    if (condition) {
        priceHtml += `<div class="price-row"><span class="price-label">Condition:</span><span class="condition-badge">${condition}</span></div>`;
    }
    
    // Show estimated value (condition-adjusted or user estimate)
    if (estimatedValue) {
        priceHtml += `<div class="estimated-value">Est. Value: $${estimatedValue.toFixed(2)}</div>`;
    } else if (userEstimate) {
        priceHtml += `<div class="estimated-value">User Est: $${userEstimate.toFixed(2)}</div>`;
    } else if (priceMedian && condition) {
        // Calculate condition-adjusted price if we have median and condition
        const conditionMultipliers = {
            "M": 1.0, "NM": 0.95, "VG+": 0.85, "VG": 0.70, "G+": 0.50, "G": 0.30, "P": 0.10
        };
        const multiplier = conditionMultipliers[condition] || 1.0;
        const adjustedPrice = priceMedian * multiplier;
        priceHtml += `<div class="estimated-value">Est. Value: $${adjustedPrice.toFixed(2)}</div>`;
    }
    
    priceHtml += '</div>';
    return priceHtml;
}

function renderLyricsSection(record) {
    const lyricsData = record.lyrics_data || {};
    const lyricsLinks = lyricsData.lyrics_links || [];
    const playLinks = lyricsData.play_links || [];
    const lyricsOvh = lyricsData.lyrics_ovh;
    
    if (!lyricsLinks.length && !playLinks.length && !lyricsOvh) {
        return '';
    }
    
    let lyricsHtml = '<div class="pricing-section" style="margin-top: 12px;">';
    lyricsHtml += '<div class="pricing-header">🎵 Lyrics & Play</div>';
    
    // Lyrics links
    if (lyricsLinks.length > 0) {
        lyricsHtml += '<div style="margin-bottom: 8px;"><strong style="font-size: 12px; color: #6B7280;">Lyrics:</strong></div>';
        lyricsLinks.forEach(link => {
            lyricsHtml += `<div style="margin-bottom: 4px;"><a href="${link.url}" target="_blank" rel="noopener noreferrer" style="font-size: 12px; color: #4F46E5; text-decoration: none;">${link.name}</a></div>`;
        });
    }
    
    // Play links (Spotify, YouTube)
    if (playLinks.length > 0) {
        lyricsHtml += '<div style="margin-top: 8px; margin-bottom: 8px;"><strong style="font-size: 12px; color: #6B7280;">Play:</strong></div>';
        playLinks.forEach(link => {
            lyricsHtml += `<div style="margin-bottom: 4px;"><a href="${link.url}" target="_blank" rel="noopener noreferrer" style="font-size: 12px; color: #4F46E5; text-decoration: none;">${link.name}</a></div>`;
        });
    }
    
    // Lyrics.ovh (direct lyrics text if available)
    if (lyricsOvh && lyricsOvh.has_lyrics) {
        lyricsHtml += '<div style="margin-top: 8px;"><small style="font-size: 11px; color: #9CA3AF;">Lyrics available via Lyrics.ovh</small></div>';
    }
    
    lyricsHtml += '</div>';
    return lyricsHtml;
}

function renderSheetMusicSection(record) {
    const sheetMusicData = record.sheet_music_data || {};
    const sheetMusicLinks = sheetMusicData.sheet_music_links || [];
    
    if (!sheetMusicLinks.length) {
        return '';
    }
    
    let sheetMusicHtml = '<div class="pricing-section" style="margin-top: 12px;">';
    sheetMusicHtml += '<div class="pricing-header">🎼 Sheet Music</div>';
    
    sheetMusicLinks.forEach(link => {
        const typeLabel = link.type ? ` (${link.type})` : '';
        sheetMusicHtml += `<div style="margin-bottom: 4px;"><a href="${link.url}" target="_blank" rel="noopener noreferrer" style="font-size: 12px; color: #4F46E5; text-decoration: none;">${link.name}${typeLabel}</a></div>`;
    });
    
    sheetMusicHtml += '</div>';
    return sheetMusicHtml;
}

function renderMarketplaceSection(record) {
    const archiveId = record.archive_id;
    const listings = record.listings || [];
    const hasListings = listings.length > 0;
    const soldListing = listings.find(l => l.status === 'sold');
    const activeListings = listings.filter(l => l.status === 'active' || l.status === 'pending');
    
    let marketplaceHtml = '<div class="pricing-section" style="margin-top: 12px;">';
    marketplaceHtml += '<div class="pricing-header">💼 Marketplace</div>';
    
    if (soldListing) {
        marketplaceHtml += `<div style="margin-bottom: 8px; padding: 8px; background: #FEF3C7; border-radius: 6px; border: 1px solid #FCD34D;">`;
        marketplaceHtml += `<div style="font-size: 12px; color: #92400E; font-weight: 600;">✓ SOLD on ${soldListing.platform.toUpperCase()}</div>`;
        if (soldListing.sold_price) {
            marketplaceHtml += `<div style="font-size: 11px; color: #78350F; margin-top: 4px;">Price: $${soldListing.sold_price.toFixed(2)}</div>`;
        }
        marketplaceHtml += `</div>`;
    } else if (activeListings.length > 0) {
        marketplaceHtml += `<div style="margin-bottom: 8px; font-size: 12px; color: #059669; font-weight: 600;">Active on ${activeListings.length} platform(s):</div>`;
        activeListings.forEach(listing => {
            const statusBadge = listing.status === 'active' ? '🟢' : '🟡';
            marketplaceHtml += `<div style="margin-bottom: 4px; font-size: 11px; color: #6B7280;">${statusBadge} ${listing.platform.toUpperCase()} - $${listing.price?.toFixed(2) || 'N/A'}</div>`;
        });
    } else {
        marketplaceHtml += `<div style="margin-bottom: 8px; font-size: 12px; color: #6B7280;">Not listed for sale</div>`;
    }
    
    // Quick Sell Button
    if (!soldListing) {
        marketplaceHtml += `<button class="btn btn-primary" onclick="quickSell('${archiveId}')" style="margin-top: 8px; width: 100%; padding: 8px 16px; font-size: 13px; font-weight: 600;">🚀 Quick Sell</button>`;
    }
    
    // View Listings Button (if has listings)
    if (hasListings) {
        marketplaceHtml += `<button class="btn" onclick="viewListings('${archiveId}')" style="margin-top: 8px; width: 100%; padding: 8px 16px; font-size: 13px;">View Listings</button>`;
    }
    
    marketplaceHtml += '</div>';
    return marketplaceHtml;
}

function renderRecords(records) {
    const container = document.getElementById('recordsContainer');

    if (records.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">📭</div>
                <h2>No Records Yet</h2>
                <p>Your archive is empty. Start by uploading your first record.</p>
                <button class="btn btn-primary" onclick="window.location.href='upload.html'" style="margin-top: 16px; display: inline-block;">
                    Upload First Record
                </button>
            </div>
        `;
        return;
    }

    const recordsHtml = records.map(record => {
        const pricingHtml = renderPricingSection(record);
        const lyricsHtml = renderLyricsSection(record);
        const sheetMusicHtml = renderSheetMusicSection(record);
        return `
            <div class="record-card">
                ${record.thumbnail_url || record.file_path ? `
                    <img 
                        src="${record.thumbnail_url || record.file_path}" 
                        alt="${record.album || 'Record'}" 
                        class="record-image"
                        onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22320%22 height=%22240%22%3E%3Crect fill=%22%23F3F4F6%22 width=%22320%22 height=%22240%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%236B7280%22 font-size=%2248%22%3E📀%3C/text%3E%3C/svg%3E'"
                    >
                ` : `
                    <div class="record-image" style="background: #F3F4F6; display: flex; align-items: center; justify-content: center; font-size: 48px;">📀</div>
                `}
                <div class="record-content">
                    <div class="record-title">${record.album || record.title || 'Unknown Album'}</div>
                    <div class="record-artist">${record.artist || 'Unknown Artist'}</div>
                    
                    <div class="record-meta">
                        ${record.label ? `<div class="meta-item"><strong>Label:</strong> ${record.label}</div>` : ''}
                        ${record.year ? `<div class="meta-item"><strong>Year:</strong> ${record.year}</div>` : ''}
                        ${record.catalog_number ? `<div class="meta-item"><strong>Catalog:</strong> ${record.catalog_number}</div>` : ''}
                        ${record.format ? `<div class="meta-item"><strong>Format:</strong> ${record.format}</div>` : ''}
                        ${record.condition ? `<div class="meta-item"><span class="condition-badge">${record.condition}</span></div>` : ''}
                    </div>
                    
                    ${pricingHtml}
                    ${lyricsHtml}
                    ${sheetMusicHtml}
                    ${renderMarketplaceSection(record)}
                    
                    <div class="record-actions">
                        <button class="btn btn-primary" onclick="openEditModal('${record.archive_id}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteRecord('${record.archive_id}')">Delete</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `<div class="records-grid">${recordsHtml}</div>`;
}

function filterRecords() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const filtered = allRecords.filter(record => {
        const artist = (record.artist || '').toLowerCase();
        const album = (record.album || record.title || '').toLowerCase();
        const label = (record.label || '').toLowerCase();
        const catalog = (record.catalog_number || '').toLowerCase();
        const searchText = `${artist} ${album} ${label} ${catalog}`;
        return searchText.includes(query);
    });
    renderRecords(filtered);
}

function openEditModal(archiveId) {
    const record = allRecords.find(r => r.archive_id === archiveId);
    if (!record) return;

    document.getElementById('editArchiveId').value = archiveId;
    document.getElementById('editArtist').value = record.artist || '';
    document.getElementById('editAlbum').value = record.album || record.title || '';
    document.getElementById('editLabel').value = record.label || '';
    document.getElementById('editYear').value = record.year || '';
    document.getElementById('editCatalog').value = record.catalog_number || '';
    document.getElementById('editCondition').value = record.media_condition || record.condition || '';
    document.getElementById('editUserEstimate').value = record.user_estimated_value || '';
    document.getElementById('priceInfo').innerHTML = '';
    
    // Load existing market prices if available (from pricing_data or direct fields)
    const pricingData = record.pricing_data || {};
    const marketPrices = pricingData.market_prices || record.market_prices || {};
    const priceLow = record.price_low || marketPrices.price_low || pricingData.price_low;
    const priceHigh = record.price_high || marketPrices.price_high || pricingData.price_high;
    const priceMedian = record.price_median || marketPrices.price_median || pricingData.price_median;
    
    if (priceLow || priceHigh) {
        let priceText = '<div style="margin-bottom: 8px;"><strong>Market Prices:</strong></div>';
        if (priceLow && priceHigh) {
            priceText += `<div style="color: #059669; font-weight: 500;">Low: $${priceLow.toFixed(2)} - High: $${priceHigh.toFixed(2)}</div>`;
        } else if (priceLow) {
            priceText += `<div style="color: #059669; font-weight: 500;">From $${priceLow.toFixed(2)}</div>`;
        }
        if (priceMedian) {
            priceText += `<div style="color: #6B7280; font-size: 12px; margin-top: 4px;">Median: $${priceMedian.toFixed(2)}</div>`;
        }
        document.getElementById('priceInfo').innerHTML = priceText;
        
        // Auto-calculate if condition is set
        if (record.media_condition || record.condition) {
            calculateConditionPrice();
        }
    }
    
    document.getElementById('editModal').classList.add('active');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('active');
}

document.getElementById('editForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const archiveId = document.getElementById('editArchiveId').value;
    const condition = document.getElementById('editCondition').value;
    const userEstimate = parseFloat(document.getElementById('editUserEstimate').value) || null;
    
    const payload = {
        artist: document.getElementById('editArtist').value,
        album: document.getElementById('editAlbum').value,
        label: document.getElementById('editLabel').value,
        year: document.getElementById('editYear').value,
        catalog_number: document.getElementById('editCatalog').value,
        media_condition: condition,
        condition: condition, // Keep both for compatibility
        user_estimated_value: userEstimate,
        user_estimate: userEstimate // Keep both for compatibility
    };
    
    // Calculate and include estimated value if condition is set
    if (condition || userEstimate) {
        const record = allRecords.find(r => r.archive_id === archiveId);
        if (record) {
            const pricingData = record.pricing_data || {};
            const marketPrices = pricingData.market_prices || record.market_prices || {};
            const priceMedian = record.price_median || marketPrices.price_median || pricingData.price_median;
            
            const conditionMultipliers = {
                "M": 1.0, "NM": 0.95, "VG+": 0.85, "VG": 0.70, "G+": 0.50, "G": 0.30, "P": 0.10
            };
            
            const basePrice = userEstimate || priceMedian || 0;
            const multiplier = condition ? (conditionMultipliers[condition] || 1.0) : 1.0;
            const estimatedValue = basePrice * multiplier;
            
            payload.estimated_value = estimatedValue;
            payload.condition_adjusted = estimatedValue;
        }
    }

    try {
        const response = await fetch(`${API_BASE}/upap/archive/record/${archiveId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${currentUser.token}`
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error('Failed to update record');
        }

        closeEditModal();
        loadLibrary(); // Reload library
    } catch (error) {
        alert('Error updating record: ' + error.message);
    }
});

async function deleteRecord(archiveId) {
    if (!confirm('Are you sure you want to delete this record?')) {
        return;
    }

    try {
        const response = await fetch(`${API_BASE}/upap/archive/record/${archiveId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${currentUser.token}`
            }
        });

        if (!response.ok) {
            throw new Error('Failed to delete record');
        }

        loadLibrary(); // Reload library
    } catch (error) {
        alert('Error deleting record: ' + error.message);
    }
}

// Close modal on background click
document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditModal();
    }
});

// Fetch market prices for current record in edit modal
async function fetchMarketPrices() {
    const artist = document.getElementById('editArtist').value;
    const album = document.getElementById('editAlbum').value;
    const catalog = document.getElementById('editCatalog').value;
    const label = document.getElementById('editLabel').value;
    const archiveId = document.getElementById('editArchiveId').value;
    
    if (!artist || !album) {
        alert('Please enter Artist and Album to fetch market prices');
        return;
    }
    
    const btn = document.querySelector('.fetch-price-btn');
    const priceInfo = document.getElementById('priceInfo');
    btn.disabled = true;
    priceInfo.innerHTML = '<div class="loading-price">Fetching prices...</div>';
    
    try {
        const params = new URLSearchParams({
            artist: artist,
            album: album
        });
        if (catalog) params.append('catalog_number', catalog);
        if (label) params.append('label', label);
        
        const response = await fetch(`${API_BASE}/vinyl/pricing/market-prices?${params}`, {
            headers: {
                'Authorization': `Bearer ${currentUser.token}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch prices');
        }
        
        const data = await response.json();
        const prices = data.prices || {};
        
        // Calculate estimated value with condition
        const condition = document.getElementById('editCondition').value;
        const userEstimate = parseFloat(document.getElementById('editUserEstimate').value) || null;
        
        if (prices.price_low || prices.price_high) {
            let priceText = '<div style="color: #059669; font-weight: 500;">Market Prices:</div>';
            if (prices.price_low && prices.price_high) {
                priceText += `<div>Low: <span class="price-low">$${prices.price_low}</span> | High: <span class="price-high">$${prices.price_high}</span></div>`;
                if (prices.price_median) {
                    priceText += `<div>Median: $${prices.price_median}</div>`;
                }
            }
            
            // Calculate condition-adjusted value
            if (condition && prices.price_median) {
                const estimateResponse = await fetch(`${API_BASE}/vinyl/pricing/estimate-value?artist=${encodeURIComponent(artist)}&album=${encodeURIComponent(album)}&condition=${encodeURIComponent(condition)}${userEstimate ? `&user_estimate=${userEstimate}` : ''}`, {
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`
                    }
                });
                
                if (estimateResponse.ok) {
                    const estimateData = await estimateResponse.json();
                    const estimate = estimateData.estimate || {};
                    if (estimate.condition_adjusted) {
                        priceText += `<div style="margin-top: 8px; font-weight: 600; color: #4F46E5;">Est. Value (${condition}): $${estimate.condition_adjusted.toFixed(2)}</div>`;
                    }
                }
            }
            
            priceInfo.innerHTML = priceText;
            
            // Update record with market prices
            const record = allRecords.find(r => r.archive_id === archiveId);
            if (record) {
                record.market_prices = prices;
            }
        } else {
            priceInfo.innerHTML = '<div style="color: #6B7280;">No market prices found for this record.</div>';
        }
        
    } catch (error) {
        priceInfo.innerHTML = `<div style="color: #EF4444;">Error: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
    }
}

// Auto-calculate estimated value when condition or user estimate changes
function calculateConditionPrice() {
    const archiveId = document.getElementById('editArchiveId').value;
    const record = allRecords.find(r => r.archive_id === archiveId);
    if (!record) return;
    
    const condition = document.getElementById('editCondition').value;
    const userEstimate = parseFloat(document.getElementById('editUserEstimate').value) || null;
    const priceInfo = document.getElementById('priceInfo');
    
    // Get existing market prices
    const pricingData = record.pricing_data || {};
    const marketPrices = pricingData.market_prices || record.market_prices || {};
    const priceMedian = record.price_median || marketPrices.price_median || pricingData.price_median;
    
    if (!priceMedian && !userEstimate) {
        return; // No base price to calculate from
    }
    
    // Condition multipliers (Goldmine standard)
    const conditionMultipliers = {
        "M": 1.0, "NM": 0.95, "VG+": 0.85, "VG": 0.70, "G+": 0.50, "G": 0.30, "P": 0.10
    };
    
    const basePrice = userEstimate || priceMedian || 0;
    const multiplier = condition ? (conditionMultipliers[condition] || 1.0) : 1.0;
    const estimatedValue = basePrice * multiplier;
    
    // Update price info display
    let priceText = priceInfo.innerHTML;
    
    // Remove existing estimated value line if present
    priceText = priceText.replace(/<div[^>]*>Est\. Value[^<]*<\/div>/gi, '');
    
    if (condition && basePrice > 0) {
        priceText += `<div style="margin-top: 8px; font-weight: 600; color: #4F46E5;">Est. Value (${condition}): $${estimatedValue.toFixed(2)}</div>`;
    } else if (userEstimate) {
        priceText += `<div style="margin-top: 8px; font-weight: 600; color: #4F46E5;">User Est: $${userEstimate.toFixed(2)}</div>`;
    }
    
    priceInfo.innerHTML = priceText;
}

// Set up event listeners for condition and user estimate changes
document.addEventListener('DOMContentLoaded', function() {
    const conditionSelect = document.getElementById('editCondition');
    const userEstimateInput = document.getElementById('editUserEstimate');
    
    if (conditionSelect) {
        conditionSelect.addEventListener('change', calculateConditionPrice);
    }
    if (userEstimateInput) {
        userEstimateInput.addEventListener('input', calculateConditionPrice);
    }
});

// Marketplace functions
async function quickSell(archiveId) {
    if (!confirm('Create listings on all platforms (Discogs, eBay, Etsy, Amazon)?')) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/marketplace/quick-sell`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${currentUser.token}`
            },
            body: JSON.stringify({
                archive_id: archiveId,
                platforms: ['discogs', 'ebay', 'etsy', 'amazon']
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Failed to create listings');
        }
        
        const data = await response.json();
        alert(`✅ Listings created on ${data.listings?.length || 0} platform(s)!`);
        loadLibrary(); // Reload to show listings
    } catch (error) {
        alert('Error creating listings: ' + error.message);
        console.error('Quick sell error:', error);
    }
}

async function viewListings(archiveId) {
    try {
        const response = await fetch(`${API_BASE}/marketplace/listings/${archiveId}`, {
            headers: {
                'Authorization': `Bearer ${currentUser.token}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load listings');
        }
        
        const data = await response.json();
        const listings = data.listings || [];
        
        if (listings.length === 0) {
            alert('No listings found for this record.');
            return;
        }
        
        // Show listings in a modal or alert
        let listingsText = 'Current Listings:\n\n';
        listings.forEach(listing => {
            const statusEmoji = listing.status === 'sold' ? '✅' : 
                               listing.status === 'active' ? '🟢' : 
                               listing.status === 'pending' ? '🟡' : '🔴';
            listingsText += `${statusEmoji} ${listing.platform.toUpperCase()}: ${listing.status.toUpperCase()}\n`;
            listingsText += `   Price: $${listing.price?.toFixed(2) || 'N/A'}\n`;
            if (listing.status === 'sold' && listing.sold_price) {
                listingsText += `   Sold for: $${listing.sold_price.toFixed(2)}\n`;
            }
            listingsText += `   URL: ${listing.url || 'N/A'}\n\n`;
        });
        
        alert(listingsText);
    } catch (error) {
        alert('Error loading listings: ' + error.message);
        console.error('View listings error:', error);
    }
}

async function markAsSold(archiveId, listingId, soldPrice) {
    const price = prompt('Enter sold price:', soldPrice || '');
    if (!price || isNaN(price)) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/marketplace/listing/${listingId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${currentUser.token}`
            },
            body: JSON.stringify({
                status: 'sold',
                sold_price: parseFloat(price)
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to update listing status');
        }
        
        const data = await response.json();
        
        if (data.closed_other_listings) {
            alert('✅ Marked as sold! Other listings have been automatically closed.');
        } else {
            alert('✅ Marked as sold!');
        }
        
        loadLibrary(); // Reload to show updated status
    } catch (error) {
        alert('Error updating listing: ' + error.message);
        console.error('Mark as sold error:', error);
    }
}
</script>

</body>
</html>
