<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Pending Records</title>

<style>
body {
    background: #f5f7fa;
    font-family: system-ui, sans-serif;
}

.header {
    padding: 20px;
    background: #111827;
    color: white;
}

.container {
    max-width: 900px;
    margin: 30px auto;
}

.card {
    background: white;
    padding: 20px;
    border-radius: 14px;
    box-shadow: 0 5px 14px rgba(0,0,0,0.1);
    margin-bottom: 18px;
}

button {
    padding: 8px 14px;
    border: none;
    border-radius: 8px;
    margin-right: 8px;
    cursor: pointer;
}

.accept { background: #2e7d32; color: white; }
.reject { background: #c62828; color: white; }
</style>

</head>

<body>

<div class="header">
    <h2>Admin Panel – Pending Records</h2>
</div>

<div class="container" id="list"></div>

<script>
// C-2: HTML escape helper
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function loadPending() {
    let r = await fetch('/admin/pending');
    let items = await r.json();
    render(items);
}

function render(items) {
    const el = document.getElementById('list');
    if (!el) return;
    
    el.innerHTML = '';

    items.forEach(p => {
        // C-2: Escape user data to prevent XSS
        const cardDiv = document.createElement('div');
        cardDiv.className = 'card';
        
        const idSpan = document.createElement('b');
        idSpan.textContent = 'ID: ';
        cardDiv.appendChild(idSpan);
        cardDiv.appendChild(document.createTextNode(escapeHtml(String(p.id || ''))));
        cardDiv.appendChild(document.createElement('br'));
        
        const userSpan = document.createElement('b');
        userSpan.textContent = 'User: ';
        cardDiv.appendChild(userSpan);
        cardDiv.appendChild(document.createTextNode(escapeHtml(String(p.user || ''))));
        cardDiv.appendChild(document.createElement('br'));
        
        const textSpan = document.createElement('b');
        textSpan.textContent = 'Text: ';
        cardDiv.appendChild(textSpan);
        cardDiv.appendChild(document.createTextNode(escapeHtml(String(p.text || ''))));
        cardDiv.appendChild(document.createElement('br'));
        cardDiv.appendChild(document.createElement('br'));
        
        // H-1: Remove inline onclick - use event delegation
        const approveBtn = document.createElement('button');
        approveBtn.className = 'accept';
        approveBtn.textContent = 'Accept';
        approveBtn.dataset.action = 'approve';
        approveBtn.dataset.id = String(p.id || '');
        
        const rejectBtn = document.createElement('button');
        rejectBtn.className = 'reject';
        rejectBtn.textContent = 'Reject';
        rejectBtn.dataset.action = 'reject';
        rejectBtn.dataset.id = String(p.id || '');
        
        cardDiv.appendChild(approveBtn);
        cardDiv.appendChild(rejectBtn);
        
        el.appendChild(cardDiv);
    });
    
    // H-1: Event delegation for buttons
    el.addEventListener('click', function(e) {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        
        if (action === 'approve') {
            approve(id);
        } else if (action === 'reject') {
            reject(id);
        }
    });
}

async function approve(id) {
    await fetch('/admin/approve/' + id, { method: 'POST' });
    loadPending();
}

async function reject(id) {
    await fetch('/admin/reject/' + id, { method: 'POST' });
    loadPending();
}

loadPending();
</script>

</body>
</html>
