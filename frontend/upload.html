<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Novitsky Archive – Upload Record</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Upload Record – Novitsky Archive</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #F9FAFB;
            color: #111827;
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Navbar */
        header {
            background: #FFFFFF;
            border-bottom: 1px solid #E5E7EB;
            padding: 16px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            letter-spacing: -0.5px;
        }

        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: #111827;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
        }

        .header-nav {
            display: flex;
            gap: 32px;
            align-items: center;
        }

        .header-nav a {
            color: #6B7280;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.2s;
        }

        .header-nav a:hover {
            color: #111827;
        }

        .header-nav a.active {
            color: #4F46E5;
        }

        /* Main Container */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 48px 24px;
        }

        /* Upload Card */
        .upload-card {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 48px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            border: 1px solid #E5E7EB;
        }

        /* Header Section */
        .card-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .card-header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .card-header p {
            font-size: 14px;
            color: #6B7280;
            font-weight: 500;
        }

        /* Pipeline Stepper */
        .pipeline-stepper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 24px 0;
            border-bottom: 1px solid #E5E7EB;
        }

        .stepper-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .stepper-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 12px;
            left: 60%;
            width: 80%;
            height: 2px;
            background: #E5E7EB;
            z-index: 0;
        }

        .stepper-step.active::after {
            background: #4F46E5;
        }

        .stepper-step.completed::after {
            background: #4F46E5;
        }

        .stepper-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #F3F4F6;
            border: 2px solid #E5E7EB;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #9CA3AF;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }

        .stepper-step.active .stepper-circle {
            background: #4F46E5;
            border-color: #4F46E5;
            color: #FFFFFF;
        }

        .stepper-step.completed .stepper-circle {
            background: #10B981;
            border-color: #10B981;
            color: #FFFFFF;
        }

        .stepper-step.completed .stepper-circle::before {
            content: '✓';
        }

        .stepper-label {
            margin-top: 8px;
            font-size: 12px;
            font-weight: 500;
            color: #6B7280;
        }

        .stepper-step.active .stepper-label {
            color: #4F46E5;
            font-weight: 600;
        }

        .stepper-step.completed .stepper-label {
            color: #10B981;
        }

        /* User Info */
        .user-info {
            background: #F0F9FF;
            border: 1px solid #BAE6FD;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 32px;
            font-size: 14px;
            color: #0369A1;
        }

        .user-info strong {
            font-weight: 600;
        }

        /* Drag & Drop Zone */
        .drop-zone {
            border: 2px dashed #D1D5DB;
            border-radius: 12px;
            padding: 48px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #FAFAFA;
            margin-bottom: 24px;
        }

        .drop-zone:hover {
            border-color: #4F46E5;
            background: #F5F3FF;
        }

        .drop-zone.dragover {
            border-color: #4F46E5;
            background: #EEF2FF;
            transform: scale(1.02);
        }

        .drop-zone-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            color: #9CA3AF;
        }

        .drop-zone-icon svg {
            width: 100%;
            height: 100%;
        }

        .drop-zone-text {
            font-size: 16px;
            font-weight: 500;
            color: #111827;
            margin-bottom: 4px;
        }

        .drop-zone-hint {
            font-size: 14px;
            color: #6B7280;
        }

        .drop-zone-hint a {
            color: #4F46E5;
            text-decoration: none;
            font-weight: 500;
        }

        .drop-zone-hint a:hover {
            text-decoration: underline;
        }

        /* File Input (Hidden) */
        #fileInput {
            display: none;
        }

        /* Selected File Info */
        .file-info {
            display: none;
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .file-info.active {
            display: block;
        }

        .file-info-name {
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .file-info-size {
            font-size: 12px;
            color: #6B7280;
        }

        /* Button */
        .upload-button {
            width: 100%;
            padding: 14px 24px;
            background: #4F46E5;
            color: #FFFFFF;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .upload-button:hover:not(:disabled) {
            background: #4338CA;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        }

        .upload-button:disabled {
            background: #D1D5DB;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 24px;
            color: #6B7280;
        }

        .loading.active {
            display: block;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #E5E7EB;
            border-top-color: #4F46E5;
            border-radius: 50%;
            margin: 0 auto 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Messages */
        .message-box {
            display: none;
            padding: 16px;
            border-radius: 8px;
            margin-top: 24px;
            font-size: 14px;
        }

        .message-box.active {
            display: block;
        }

        .message-box.success {
            background: #D1FAE5;
            border: 1px solid #10B981;
            color: #065F46;
        }

        .message-box.error {
            background: #FEE2E2;
            border: 1px solid #EF4444;
            color: #991B1B;
        }

        .message-box a {
            color: #4F46E5;
            text-decoration: none;
            font-weight: 500;
            margin: 0 8px;
        }

        .message-box a:hover {
            text-decoration: underline;
        }

        /* Result Box */
        .result-box {
            display: none;
            margin-top: 24px;
            padding: 20px;
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }

        .result-box.active {
            display: block;
        }

        /* Footer */
        footer {
            background: #FFFFFF;
            border-top: 1px solid #E5E7EB;
            padding: 32px 40px;
            margin-top: 64px;
            text-align: center;
            color: #6B7280;
            font-size: 14px;
        }

        footer p {
            margin: 4px 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header {
                padding: 16px 20px;
                flex-wrap: wrap;
            }

            .mobile-menu-toggle {
                display: block;
            }

            .header-nav {
                display: none;
                flex-direction: column;
                width: 100%;
                gap: 8px;
                margin-top: 16px;
                padding-top: 16px;
                border-top: 1px solid #E5E7EB;
            }

            .header-nav.active {
                display: flex;
            }

            .header-nav a {
                width: 100%;
                text-align: center;
                padding: 12px 16px;
            }

            .container {
                padding: 24px 16px;
            }

            .upload-card {
                padding: 32px 24px;
            }

            .card-header h1 {
                font-size: 24px;
            }

            .pipeline-stepper {
                flex-wrap: wrap;
                gap: 16px;
            }

            .stepper-step {
                min-width: 80px;
            }

            .stepper-step:not(:last-child)::after {
                display: none;
            }

            .drop-zone {
                padding: 32px 16px;
            }

            footer {
                padding: 24px 20px;
            }
        }

        @media (max-width: 480px) {
            .card-header h1 {
                font-size: 20px;
            }

            .drop-zone-text {
                font-size: 14px;
            }

            .drop-zone-hint {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

<header>
    <div class="header-title">Novitsky AI</div>
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
    <nav class="header-nav" id="mobileNav">
        <a href="index.html">Home</a>
        <a href="upload.html" class="active">Upload</a>
        <a href="library.html">Library</a>
        <a href="login.html">Account</a>
    </nav>
</header>

<div class="container">
    <div class="upload-card">
        <div class="card-header">
            <h1>Upload Record</h1>
            <p>Live UPAP Pipeline v2</p>
        </div>

        <div class="pipeline-stepper" id="stepper">
            <div class="stepper-step active" data-step="upload">
                <div class="stepper-circle">1</div>
                <div class="stepper-label">Upload</div>
            </div>
            <div class="stepper-step" data-step="process">
                <div class="stepper-circle">2</div>
                <div class="stepper-label">Process</div>
            </div>
            <div class="stepper-step" data-step="archive">
                <div class="stepper-circle">3</div>
                <div class="stepper-label">Archive</div>
            </div>
            <div class="stepper-step" data-step="publish">
                <div class="stepper-circle">4</div>
                <div class="stepper-label">Publish</div>
            </div>
        </div>

        <div class="user-info" id="userInfo" style="display: none;">
            <strong>Signed in as:</strong> <span id="userEmail"></span>
        </div>

        <div class="drop-zone" id="dropZone">
            <div class="drop-zone-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
            </div>
            <div class="drop-zone-text">
                <span class="text-indigo-600 font-semibold">Upload a file</span> or drag and drop
            </div>
            <div class="drop-zone-hint">
                JPEG, PNG up to 10MB
            </div>
            <input type="file" id="fileInput" accept="image/jpeg,image/png,image/jpg">
        </div>

        <div class="file-info" id="fileInfo">
            <div class="file-info-name" id="fileName"></div>
            <div class="file-info-size" id="fileSize"></div>
        </div>

        <button class="upload-button" id="uploadBtn" onclick="uploadRecord()" disabled>
            Start Processing
        </button>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div>Processing your image through the UPAP pipeline...</div>
        </div>

        <div class="message-box success" id="successBox"></div>
        <div class="message-box error" id="errorBox"></div>
        <div class="result-box" id="resultBox"></div>
    </div>
</div>

<footer>
    <p><strong>Records_AI (UPAP Tabanlı Arşivleme Platformu)</strong></p>
    <p>Developed and owned by Merve Emecan Sanli</p>
</footer>

<script>
// Mobile menu toggle
function toggleMobileMenu() {
    const nav = document.getElementById('mobileNav');
    nav.classList.toggle('active');
}

// Close mobile menu when clicking outside
document.addEventListener('click', function(event) {
    const nav = document.getElementById('mobileNav');
    const toggle = document.querySelector('.mobile-menu-toggle');
    if (nav && toggle && !nav.contains(event.target) && !toggle.contains(event.target)) {
        nav.classList.remove('active');
    }
});

let currentRecordId = null;
let currentResult = null;

// Safe storage helpers (C-3, H-3)
function getStorage(key) {
    try {
        return localStorage.getItem(key) || sessionStorage.getItem(key);
    } catch (e) {
        return null;
    }
}

function setStorage(key, value) {
    try {
        localStorage.setItem(key, value);
        return true;
    } catch (e) {
        try {
            sessionStorage.setItem(key, value);
            return true;
        } catch (e2) {
            return false;
        }
    }
}

// HTML escape helper (C-2)
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Check authentication on page load
window.addEventListener('DOMContentLoaded', function() {
    const authToken = getStorage('auth_token');
    const userEmail = getStorage('user_email');
    
    if (!authToken || !userEmail) {
        window.location.href = 'login.html?return=' + encodeURIComponent('upload.html');
        return;
    }
    
    // Display user email (C-3: null check)
    const userEmailEl = document.getElementById('userEmail');
    const userInfoEl = document.getElementById('userInfo');
    if (userEmailEl && userInfoEl) {
        userEmailEl.textContent = userEmail;
        userInfoEl.style.display = 'block';
    }
    
    // Setup drag & drop
    setupDragAndDrop();
    setupFileInput();
});

function setupDragAndDrop() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });
    
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });
}

function setupFileInput() {
    const fileInput = document.getElementById('fileInput');
    
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
}

function handleFileSelect(file) {
    // Validate file type
    if (!file.type.match(/^image\/(jpeg|jpg|png)$/)) {
        showError('Please select a JPEG or PNG image file.');
        return;
    }
    
    // Validate file size (10MB)
    if (file.size > 10 * 1024 * 1024) {
        showError('File size must be less than 10MB.');
        return;
    }
    
    // Show file info
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('fileInfo').classList.add('active');
    
    // Enable upload button
    document.getElementById('uploadBtn').disabled = false;
    
    // Update stepper
    updateStepper('upload', 'active');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function updateStepper(step, state) {
    const stepperSteps = document.querySelectorAll('.stepper-step');
    stepperSteps.forEach((s, index) => {
        const stepName = s.dataset.step;
        s.classList.remove('active', 'completed');
        
        if (step === stepName) {
            s.classList.add(state);
        } else if (getStepOrder(stepName) < getStepOrder(step)) {
            s.classList.add('completed');
        }
    });
}

function getStepOrder(step) {
    const order = { 'upload': 1, 'process': 2, 'archive': 3, 'publish': 4 };
    return order[step] || 0;
}

function showError(message) {
    const errorBox = document.getElementById('errorBox');
    errorBox.textContent = message;
    errorBox.classList.add('active');
    document.getElementById('successBox').classList.remove('active');
}

function showSuccess(message) {
    const successBox = document.getElementById('successBox');
    const errorBox = document.getElementById('errorBox');
    if (!successBox || !errorBox) return;
    
    // C-2: Use textContent for safety (message may contain HTML from API, but we display as text)
    successBox.textContent = message;
    successBox.classList.add('active');
    errorBox.classList.remove('active');
}

async function uploadRecord() {
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const loading = document.getElementById('loading');
    const errorBox = document.getElementById('errorBox');
    const successBox = document.getElementById('successBox');
    const resultBox = document.getElementById('resultBox');

    // Reset UI
    errorBox.classList.remove('active');
    successBox.classList.remove('active');
    resultBox.classList.remove('active');

    const file = fileInput.files[0];
    
    // C-3: Null check for file
    if (!file) {
        showError('Please select a file first');
        return;
    }
    
    const authToken = getStorage('auth_token');
    const userEmail = getStorage('user_email');
    
    if (!authToken || !userEmail) {
        alert('Please sign in first');
        window.location.href = 'login.html?return=' + encodeURIComponent('upload.html');
        return;
    }

    // Validate file type
    if (!file.type || !file.type.match(/^image\/(jpeg|jpg|png)$/)) {
        showError('Please select a JPEG or PNG image file.');
        return;
    }

    // Show loading state
    uploadBtn.disabled = true;
    loading.classList.add('active');
    updateStepper('upload', 'completed');
    updateStepper('process', 'active');

    const formData = new FormData();
    formData.append("file", file);
    formData.append("email", userEmail);

    try {
        // H-2: Standardized API base
        const apiBase = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://127.0.0.1:8000'
            : window.location.origin;

        const response = await fetch(`${apiBase}/api/v1/upap/upload`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${authToken}`
            },
            body: formData
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Upload failed: ${response.status} ${errorText}`);
        }

        const data = await response.json();
        
        // Handle multiple records or single record
        let results = [];
        if (data.type === 'multiple_records' && data.records) {
            results = data.records;
        } else if (Array.isArray(data.results)) {
            results = data.results;
        } else {
            results = [data];
        }

        // Store preview data for preview page
        const previewData = results.length === 1 ? results[0] : {
            type: 'multiple_records',
            count: results.length,
            records: results
        };
        
        setStorage('preview_data', JSON.stringify(previewData));

        // Redirect to preview page for quick review
        window.location.href = 'preview.html';

    } catch (err) {
        showError(`Upload failed: ${err.message}`);
        console.error(err);
    } finally {
        uploadBtn.disabled = false;
        loading.classList.remove('active');
    }
}
</script>

</body>
</html>
